<!DOCTYPE html>
<html>

<head>
  <title>Admin - Mi Sitio</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-gray-100 text-gray-800 h-screen overflow-hidden">
  <!-- Contenedor principal con sidebar y contenido -->
  <div class="flex h-screen">

    <!-- Sidebar -->
    <aside class="w-64 bg-indigo-700 text-white flex flex-col p-6 space-y-6">
      <div class="text-2xl font-bold">AdminPanel</div>
      <nav id="paginaNav" class="flex-1 space-y-2">
        <a href="#" data-pagina="home" class="pagina-link block py-2 px-3 rounded-lg hover:bg-indigo-600">Home</a>
        <a href="#" data-pagina="git" class="pagina-link block py-2 px-3 rounded-lg hover:bg-indigo-600">Git</a>
        <a href="#" data-pagina="python"
          class="pagina-link block py-2 px-3 rounded-lg hover:bg-indigo-600">Python</a>
        <a href="#" data-pagina="laravel" class="pagina-link block py-2 px-3 rounded-lg hover:bg-indigo-600">larabel</a>
      </nav>
    </aside>

    <!-- Contenido principal -->
    <main class="flex-1 overflow-auto bg-gray-50">

      <!-- Navbar superior -->
      <header class="bg-white shadow px-6 py-4 flex justify-between items-center">
        <h1 class="text-xl font-semibold text-indigo-700">Editor de Contenido</h1>
        <div class="text-sm text-gray-500">Bienvenido, Admin</div>
      </header>

      <!-- Contenido del formulario -->
      <section class="p-6 max-w-4xl mx-auto">
        <div class="bg-white shadow-lg rounded-2xl p-6 space-y-6">

          <!-- Editor -->
          <div id="editorContainer" class="space-y-4">

            <div>
              <label for="titulo" class="block text-gray-700 font-semibold mb-2">ID del Elemento
                (<code>data-dynamic-id</code>):</label>
              <input type="text" id="titulo" placeholder="ej: header-content"
                class="w-full border-gray-300 rounded-xl shadow-sm focus:ring-indigo-500 focus:border-indigo-500 px-4 py-2" />
            </div>

            <div>
              <label for="contenido" class="block text-gray-700 font-semibold mb-2">Contenido (HTML permitido):</label>
              <textarea id="contenido" rows="6"
                class="w-full border-gray-300 rounded-xl shadow-sm focus:ring-indigo-500 focus:border-indigo-500 px-4 py-2 resize-y"
                placeholder="<h1>Mi encabezado</h1>"></textarea>
            </div>

            <div class="text-right pt-2">
              <button id="guardar"
                class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-6 py-2 rounded-xl shadow-md transition duration-300">
                Guardar Cambios
              </button>
            </div>

          </div>
        </div>
      </section>
    </main>
  </div>
  <!-- <script src="script.js"></script> -->

  <script type="module" src="../js/supabase.js"></script>
  <script type="module" src="../js/contenido.js"></script>
  <script type="module">
    import { supabase } from '../js/supabase.js';

    document.addEventListener('DOMContentLoaded', async () => {
      const getElement = (id) => {
        const el = document.getElementById(id);
        if (!el) console.error(`Elemento con ID ${id} no encontrado`);
        return el;
      };

      const navLinks = document.querySelectorAll('.pagina-link');
      const tituloInput = getElement('titulo');
      const contenidoInput = getElement('contenido');
      const guardarBtn = getElement('guardar');

      let paginaActual = 'home'; // valor por defecto

      // Verifica existencia de campos
      if (!tituloInput || !contenidoInput || !guardarBtn || navLinks.length === 0) {
        Swal.fire('Error', 'Error en la configuración de la página', 'error');
        return;
      }

      // 1. Cargar contenido desde Supabase
      async function loadContent() {
        try {
          const { data, error } = await supabase
            .from('contenido_paginas')
            .select('titulo, contenido')
            .eq('pagina', paginaActual)
            .single();

          if (error && error.code === 'PGRST116') {
            tituloInput.value = 'banner';
            contenidoInput.value = '';
            return;
          }

          if (error) throw error;

          tituloInput.value = data?.titulo || 'banner';
          contenidoInput.value = data?.contenido || '';
        } catch (error) {
          console.error('Error cargando contenido:', error);
          Swal.fire('Error', 'Error al cargar contenido', 'error');
        }
      }

      // 2. Guardar contenido
      async function saveContent() {
        try {
          const dynamicId = tituloInput.value.trim();
          const content = contenidoInput.value;

          if (!dynamicId) {
            Swal.fire('Error', 'Debes especificar un ID de elemento', 'error');
            return;
          }

          const { error } = await supabase
            .from('contenido_paginas')
            .upsert({
              pagina: paginaActual,
              titulo: dynamicId,
              contenido: content
            }, { onConflict: 'pagina' });

          if (error) throw error;

          Swal.fire('Éxito', 'Contenido guardado', 'success');
          await loadContent();
        } catch (error) {
          console.error('Error guardando:', error);
          Swal.fire('Error', 'Error al guardar: ' + error.message, 'error');
        }
      }

      // 3. Manejo de clicks en los <a>
      navLinks.forEach(link => {
        link.addEventListener('click', async (e) => {
          e.preventDefault();

          // Obtener valor de data-pagina
          const pagina = link.getAttribute('data-pagina');
          if (!pagina) return;

          paginaActual = pagina;

          // Resalta el link activo (opcional)
          navLinks.forEach(l => l.classList.remove('bg-indigo-600', 'text-white'));
          link.classList.add('bg-indigo-600', 'text-white');

          await loadContent();
        });
      });

      // 4. Guardar al hacer clic en botón
      guardarBtn.addEventListener('click', saveContent);

      // 5. Carga inicial
      await loadContent();
    });
  </script>
</body>

</html>